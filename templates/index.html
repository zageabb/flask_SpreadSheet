<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flask Spreadsheet</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.2.1/styles/ag-grid.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.2.1/styles/ag-theme-quartz.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  </head>
  <body>
    <header class="app-header">
      <div class="header-top">
        <h1>Flask Spreadsheet</h1>
        <div class="sheet-controls">
          <label for="sheet-select" class="sr-only">Active sheet</label>
          <select id="sheet-select" class="sheet-select" aria-label="Select sheet"></select>
          <button id="rename-sheet" type="button" class="action-btn secondary">Rename</button>
          <button id="save-sheet" type="button" class="action-btn secondary">Save Copy</button>
        </div>
      </div>
      <div class="header-actions">
        <button id="add-row" type="button" class="action-btn">Add Row</button>
        <button id="add-column" type="button" class="action-btn">Add Column</button>
        <button id="reset-grid" type="button" class="action-btn secondary">Clear Sheet</button>
        <button id="import-data" type="button" class="action-btn">Import Data</button>
        <a id="download-csv" class="action-btn secondary" href="#" role="button">Export CSV</a>
        <a id="download-xlsx" class="action-btn secondary" href="#" role="button">Export XLSX</a>
      </div>
    </header>

    <main class="app-main">
      <section class="sheet-container">
        <div class="formula-bar" role="group" aria-label="Formula bar">
          <span class="formula-prefix" aria-hidden="true">fx</span>
          <span id="formula-cell-label" class="formula-cell-label" aria-live="polite">Select a cell</span>
          <input
            id="formula-input"
            class="formula-input"
            type="text"
            placeholder="Enter value or formula"
            aria-label="Cell contents"
            aria-describedby="formula-cell-label"
            disabled
          />
        </div>
        <div class="sheet-wrapper">
          <div id="sheet" class="ag-theme-quartz" aria-label="Spreadsheet"></div>
        </div>
        <div id="status" role="status" aria-live="polite" class="status">Ready</div>
      </section>
    </main>

    <div id="import-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="import-modal-title">
      <div class="modal-dialog">
        <button type="button" class="modal-close" id="close-import-modal" aria-label="Close import dialog">&times;</button>
        <h2 id="import-modal-title">Import Data</h2>
        <p class="modal-description">Upload a CSV or Excel (.xlsx) file to preview its contents before importing.</p>
        <form id="import-form" class="modal-form" enctype="multipart/form-data">
          <label class="form-field" for="import-file">Choose file</label>
          <input id="import-file" name="file" type="file" accept=".csv,.xlsx" required />
          <label class="checkbox-field">
            <input id="import-include-header" name="includeHeader" type="checkbox" checked />
            <span>Treat the first row as a header row</span>
          </label>
          <div class="modal-actions">
            <button type="submit" class="action-btn">Upload</button>
            <button type="button" class="action-btn secondary" id="import-cancel">Cancel</button>
          </div>
        </form>
        <div id="import-feedback" class="import-feedback" role="alert"></div>
        <div id="import-preview" class="import-preview hidden" aria-live="polite">
          <div class="import-preview-header">
            <h3>Preview</h3>
            <p id="import-preview-meta" class="preview-meta"></p>
            <p id="import-source-name" class="preview-source"></p>
          </div>
          <div class="preview-table-wrapper">
            <table id="import-preview-table" class="preview-table"></table>
          </div>
          <div class="modal-actions">
            <button type="button" class="action-btn" id="confirm-import">Confirm Import</button>
            <button type="button" class="action-btn secondary" id="reset-import">Choose Another File</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const initialRowCount = {{ row_count }};
      const initialColCount = {{ col_count }};
      const initialSheetId = {{ sheet_id }};
      const initialSheets = {{ sheets | tojson }};
    </script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.2.1/dist/ag-grid-community.min.noStyle.js" defer></script>
    <script src="{{ url_for('static', filename='js/formula_engine.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/spreadsheet.js') }}" defer></script>
  </body>
</html>
